<script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
    if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
            var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];

            // Convert sheet to JSON to filter blank rows
            var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
            // Filter out blank rows (rows where all cells are empty, null, or undefined)
            var filteredData = jsonData.filter(row => row.some(filledCell));

            // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
            var headerRowIndex = filteredData.findIndex((row, index) =>
              row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
            );
            // Fallback
            if (headerRowIndex === -1 || headerRowIndex > 25) {
              headerRowIndex = 0;
            }

            // Convert filtered JSON back to CSV
            var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
            csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
            return csv;
        } catch (e) {
            console.error(e);
            return "";
        }
    }
    return gk_fileData[filename] || "";
    }
    </script><!DOCTYPE html>
<html lang="ru">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞–∑–∏–Ω–æ Web App</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #121212;
        color: #E0E0E0;
        margin: 0;
        padding: 0;
        overscroll-behavior-y: contain;
    }
    #app-container {
        max-width: 100%;
        min-height: 100vh;
    }
    .header {
        background-color: #1E1E1E;
        border-bottom: 1px solid #2D2D2D;
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        object-fit: cover;
    }
    .user-name {
        font-weight: 500;
        font-size: 1.125rem;
    }
    .case-item {
        background-color: #2D2D2D;
        border: 2px solid transparent;
        transition: border-color 0.3s ease;
    }
    .case-item:hover {
        border-color: #1E88E5;
    }
    .btn-primary {
        background-color: #1E88E5;
        color: white;
    }
    .btn-primary:hover {
        background-color: #1976D2;
    }
    .btn-secondary {
        background-color: #424242;
        color: #E0E0E0;
    }
    .btn-secondary:hover {
        background-color: #525252;
    }
    .plus-icon {
        color: #29B6F6;
        cursor: pointer;
    }
    .minus-icon {
        color: #757575;
        cursor: not-allowed;
    }
    .reel-container {
        overflow: hidden;
        position: relative;
        height: 120px;
        border: 2px solid #1E88E5;
        background-color: #0A0A0A;
        display: flex;
        align-items: center;
    }
    .reel {
        display: flex;
        transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    .reel-item {
        min-width: 100px;
        height: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-right: 1px solid #424242;
        padding: 10px;
        text-align: center;
        background-color: #2D2D2D;
        margin: 10px 5px;
        padding-right: 100px;
        border-radius: 8px;
    }
    .reel-item-icon {
        font-size: 2rem;
        margin-bottom: 5px;
    }
    .reel-item-value {
        font-size: 0.9rem;
        font-weight: 500;
    }
    .rarity-Common { color: #E0E0E0; border-left: 5px solid #9E9E9E; }
    .rarity-Uncommon { color: #81C784; border-left: 5px solid #66BB6A; }
    .rarity-Rare { color: #64B5F6; border-left: 5px solid #42A5F5; }
    .rarity-Epic { color: #BA68C8; border-left: 5px solid #AB47BC; }
    .rarity-Legendary { color: #FFB74D; border-left: 5px solid #FFA726; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .case-content-item {
        background-color: #222222; padding: 8px; border-radius: 6px;
        margin-bottom: 6px; font-size: 0.9em;
    }
    .message-box {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background-color: #1E88E5; color: white; padding: 15px 25px;
        border-radius: 8px; z-index: 1000; display: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .tab-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #1E1E1E;
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        border-top: 1px solid #2D2D2D;
    }
    .tab-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #757575;
        font-size: 0.8rem;
        cursor: pointer;
    }
    .tab-button.active {
        color: #1E88E5;
    }
    .tab-icon {
        font-size: 1.5rem;
        margin-bottom: 4px;
    }
    .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #424242;
        outline: none;
        margin: 15px 0;
    }
    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #1E88E5;
        cursor: pointer;
    }
    .slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #1E88E5;
        cursor: pointer;
    }
    .bet-controls {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 5px;
        margin-bottom: 5px;
    }
    .bet-btn {
        padding: 8px;
        border-radius: 6px;
        background-color: #2D2D2D;
        text-align: center;
        cursor: pointer;
    }
    .bet-btn:hover {
        background-color: #3D3D3D;
    }
    .bet-input {
        background-color: #2D2D2D;
        border: none;
        border-radius: 6px;
        padding: 10px;
        color: white;
        text-align: center;
        font-size: 1rem;
        width: 100%;
        margin-bottom: 10px;
    }
    .win-amount {
        font-size: 1.2rem;
        font-weight: bold;
        color: #81C784;
        margin: 10px 0;
    }
    .dice-percent {
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        margin: 20px 0;
    }
    .coin-session {
        background-color: #2D2D2D;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .coin-session:hover {
        background-color: #3D3D3D;
    }
    .coin-video {
        width: 200px;
        height: 200px;
        margin: 0 auto;
        display: block;
    }
    .coin-result-icon {
        font-size: 5rem;
        display: inline-block;
        margin: 20px 0;
    }
</style>
<head>
    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ head -->
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>
</head>
</head>
<body class="text-gray-200">

<div id="app-container" class="mx-auto min-h-screen flex flex-col pb-16">

    <header class="header p-4 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center">
            <img id="user-photo" src="https://placehold.co/40x40/1E88E5/FFFFFF?text=U" alt="–ê–≤–∞—Ç–∞—Ä" class="user-avatar">
            <span id="user-name" class="user-name">User</span>
            <span id="user-balance" class="ml-4 font-semibold">10,000 $</span>
        </div>
        <div class="flex items-center space-x-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7 plus-icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7 minus-icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" />
            </svg>
        </div>
    </header>

    <!-- –í–∫–ª–∞–¥–∫–∞ –ö–µ–π—Å—ã -->
    <main id="cases-page" class="flex-grow p-4">
        <h1 class="text-2xl font-bold mb-6 text-center">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ö–µ–π—Å—ã</h1>
        <div id="case-list-container" class="grid grid-cols-2 gap-4">
            <!-- –ö–µ–π—Å—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
        </div>
    </main>

    <section id="case-detail-page" class="hidden flex-grow p-4 flex flex-col">
        <button id="back-to-main" class="btn-secondary py-2 px-4 rounded-lg self-start mb-4">‚Üê –ù–∞–∑–∞–¥</button>
        <h2 id="case-name-display" class="text-3xl font-bold mb-2 text-center"></h2>
        <div id="case-icon-display" class="text-6xl text-center my-4"></div>
        <p id="case-price-display" class="text-2xl font-semibold text-center mb-4"></p>
        
        <button id="buy-case-button" class="btn-primary w-full py-3 px-4 rounded-lg text-lg font-semibold mb-6">–ö—É–ø–∏—Ç—å –∫–µ–π—Å</button>

        <div id="reel-section" class="hidden mb-6">
            <h3 class="text-xl font-semibold mb-3 text-center">–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞...</h3>
            <div class="reel-container rounded-lg">
                <div id="reel" class="reel">
                    <!-- –ê–Ω–∏–º–∞—Ü–∏—è –±–∞—Ä–∞–±–∞–Ω–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
                <div class="w-1 h-full bg-red-500 absolute z-10 left-1/2 top-0 transform -translate-x-1/2 pointer-events-none" style="height: 120px;"></div>
            </div>
        </div>
        
        <div id="result-display" class="hidden text-center mb-6 p-4 bg-gray-700 rounded-lg">
            <h3 class="text-xl font-semibold mb-2">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞—à –≤—ã–∏–≥—Ä—ã—à:</h3>
            <div id="won-item-icon" class="text-5xl my-3"></div>
            <p id="won-item-value" class="text-2xl font-bold"></p>
            <p id="won-item-rarity" class="text-lg"></p>
            <button id="try-again-button" class="btn-primary mt-4 py-2 px-6 rounded-lg">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>

        <h3 class="text-xl font-semibold mb-3 mt-2">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞:</h3>
        <div id="case-contents-display" class="no-scrollbar overflow-y-auto max-h-60 bg-gray-800 p-3 rounded-lg">
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
    </section>

    <!-- –í–∫–ª–∞–¥–∫–∞ Dice -->
    <section id="dice-page" class="hidden flex-grow p-4 flex flex-col">
        <div class="dice-percent" id="dice-percent">50%</div>
        
        <input type="range" min="1" max="80" value="50" class="slider" id="dice-slider">
        
        <div class="flex justify-between mb-4">
            <button id="dice-minus5" class="btn-secondary py-2 px-4 rounded-lg">-5%</button>
            <button id="dice-minus1" class="btn-secondary py-2 px-4 rounded-lg">-1%</button>
            <input type="number" id="dice-percent-input" min="1" max="80" value="50" class="bg-gray-700 rounded-lg px-3 w-20 text-center">
            <button id="dice-plus1" class="btn-secondary py-2 px-4 rounded-lg">+1%</button>
            <button id="dice-plus5" class="btn-secondary py-2 px-4 rounded-lg">+5%</button>
        </div>
        
        <h3 class="text-xl font-semibold mb-2">–°—Ç–∞–≤–∫–∞:</h3>
        <input type="number" id="dice-bet-input" min="2" max="1000" value="10" class="bet-input">
        
        <div class="bet-controls">
            <div class="bet-btn" id="dice-bet-min">Min</div>
            <div class="bet-btn" id="dice-bet-half">/2</div>
            <div class="bet-btn" id="dice-bet-double">√ó2</div>
            <div class="bet-btn" id="dice-bet-max">Max</div>
        </div>
        
        <div class="bet-controls">
            <div class="bet-btn" id="dice-bet-minus10">-10</div>
            <div class="bet-btn" id="dice-bet-minus5">-5</div>
            <div class="bet-btn" id="dice-bet-plus5">+5</div>
            <div class="bet-btn" id="dice-bet-plus10">+10</div>
        </div>
        
        <div class="win-amount" id="dice-win-amount">–í—ã–∏–≥—Ä—ã—à: 19.00 $</div>
        
        <button id="dice-play-button" class="btn-primary w-full py-3 px-4 rounded-lg text-lg font-semibold mt-4">–ò–≥—Ä–∞—Ç—å</button>
        
        <div id="dice-result" class="hidden text-center mt-6 p-4 bg-gray-700 rounded-lg">
            <div id="dice-result-icon" class="text-5xl my-3">üé≤</div>
            <p id="dice-result-text" class="text-2xl font-bold"></p>
            <p id="dice-result-amount" class="text-lg"></p>
            <button id="dice-try-again" class="btn-primary mt-4 py-2 px-6 rounded-lg">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
    </section>

    <!-- –í–∫–ª–∞–¥–∫–∞ Coin -->
    <section id="coin-page" class="hidden flex-grow p-4 flex flex-col">
        <h2 class="text-2xl font-bold mb-4">–ò–≥—Ä–∞ "–ú–æ–Ω–µ—Ç–∞"</h2>
        
        <!-- –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π -->
        <div id="coin-sessions" class="mb-6 flex-grow">
            <h3 class="text-xl font-semibold mb-3">–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏</h3>
            <div id="coin-session-list" class="no-scrollbar overflow-y-auto max-h-96"></div>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ -->
        <div id="coin-create-section" class="mt-auto">
            <button id="create-coin-session" class="btn-primary w-full py-3 px-4 rounded-lg text-lg font-semibold">–°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é</button>
            <div id="coin-bet-section" class="hidden mt-2">
                <input type="number" id="coin-bet-input" min="10" max="10000" value="10" class="bet-input" placeholder="–°—Ç–∞–≤–∫–∞ (10-10000)">
                <button id="confirm-coin-session" class="btn-primary w-full py-3 px-4 rounded-lg text-lg font-semibold mt-2">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button id="cancel-coin-session" class="btn-secondary w-full py-2 px-4 rounded-lg mt-2">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

  <!-- –ê–∫—Ç–∏–≤–Ω–∞—è –∏–≥—Ä–∞ -->
<div id="coin-game" class="hidden text-center">
    <!-- –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç—Å—á–µ—Ç–∞ -->
    <dotlottie-player id="countdown-animation" src="https://lottie.host/a35374cb-9fca-45c8-91bc-29179e616bc0/Aajf969hxq.lottie" 
        background="transparent" speed="1" style="width: 320px; height: 320px; margin: 0 auto 20px; display: none;" 
        loop autoplay>
    </dotlottie-player>
    
    <!-- –ê–Ω–∏–º–∞—Ü–∏—è –±—Ä–æ—Å–∫–∞ –º–æ–Ω–µ—Ç—ã -->
    <dotlottie-player id="coin-flip-animation" src="https://lottie.host/bbe5ac17-3c53-4b31-a01b-5a816a0b4585/UQY5rHrpgT.lottie" 
        background="transparent" speed="1" style="width: 320px; height: 320px; margin: 0 auto 20px; display: none;" 
        loop autoplay>
    </dotlottie-player>
    
    <div id="coin-status" class="text-xl mb-4"></div>
    <div id="coin-countdown" class="text-3xl font-bold mb-4"></div>
        <div id="coin-sides" class="flex justify-between mb-4">
            <div id="player-side" class="text-lg"></div>
            <div id="opponent-side" class="text-lg"></div>
        </div>
        <button id="coin-swap-side" class="btn-secondary py-2 px-4 rounded-lg mb-4">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–º–µ–Ω—è—Ç—å—Å—è —Å—Ç–æ—Ä–æ–Ω–∞–º–∏</button>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏ -->
        <div id="coin-result" class="hidden">
            <div id="coin-result-icon" class="coin-result-icon"></div>
            <p id="coin-result-text" class="text-2xl font-bold mb-2"></p>
            <p id="coin-result-amount" class="text-lg"></p>
        </div>
        
        <button id="coin-play-again" class="btn-primary py-2 px-6 rounded-lg hidden">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>
    </section>

    <div id="message-box" class="message-box">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tab-bar">
        <div class="tab-button active" id="tab-cases">
            <div class="tab-icon">üéÅ</div>
            <div>–ö–µ–π—Å—ã</div>
        </div>
        <div class="tab-button" id="tab-dice">
            <div class="tab-icon">üé≤</div>
            <div>Dice</div>
        </div>
        <div class="tab-button" id="tab-coin">
            <div class="tab-icon">ü™ô</div>
            <div>Coin</div>
        </div>
    </div>
</div>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>


<script>
    // –í –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–æ–±–∞–≤—å—Ç–µ:
const socket = io('https://win-star-drop.vercel.app/'); // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL —Å–µ—Ä–≤–µ—Ä–∞

// –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
socket.on('connect', () => {
  console.log('Connected to server');
});

socket.on('roomUpdate', (roomData) => {
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
});

socket.on('gameStart', (gameData) => {
  // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
});

socket.on('gameResult', (result) => {
  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–≥—Ä—ã
});
    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
    let currentCase = null; 
    let userBalance = 10000; 
    let totalLosses = 0;
    let jackpotPool = 0;
    let currentTab = 'cases';
    let userId = Math.random().toString(36).substr(2, 9);
    let activeCoinSession = null;

    // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤ ---
    const CASE_CONFIGS = {
        starter_case: generateCaseConfig(100),
        rare_case: generateCaseConfig(300),
        epic_case: generateCaseConfig(500),
        legendary_case: generateCaseConfig(1000)
    };

    function generateCaseConfig(basePrice) {
        const multipliers = [
            0.125, 0.25, 0.5, 0.75,
            1, 1.5, 2, 3,
            5, 7, 10, 15,
            20, 30, 40, 50
        ];
        
        const icons = [
            'ü™ô', 'üí∞', 'üí≤', '‚úîÔ∏è',
            'üî∑', 'üî∂', 'üåü', '‚ú®',
            'üíé', 'üëë', 'üèÜ', 'üéñÔ∏è',
            'üíç', 'üî±', '‚öúÔ∏è', 'üëΩ'
        ];
        
        const rarities = [
            'Common', 'Common', 'Common', 'Common',
            'Uncommon', 'Uncommon', 'Uncommon', 'Uncommon',
            'Rare', 'Rare', 'Rare', 'Rare',
            'Epic', 'Epic', 'Legendary', 'Legendary'
        ];
        
        const names = [
            '–ú–æ–Ω–µ—Ç–∞', '–ú–µ–ª–∫–∞—è –∫—É–ø—é—Ä–∞', '–ú–µ–ª–æ—á—å', '–°—Ç–∞–Ω–¥–∞—Ä—Ç',
            '–°–µ—Ä–µ–±—Ä–æ', '–ó–æ–ª–æ—Ç–æ', '–ó–≤–µ–∑–¥–∞', '–ö—Ä–∏—Å—Ç–∞–ª–ª',
            '–ê–ª–º–∞–∑', '–ö–æ—Ä–æ–Ω–∞', '–¢—Ä–æ—Ñ–µ–π', '–ú–µ–¥–∞–ª—å',
            '–ö–æ–ª—å—Ü–æ', '–°–∫–∏–ø–µ—Ç—Ä', '–ê—Ä—Ç–µ—Ñ–∞–∫—Ç', '–ò–Ω–æ–ø–ª–∞–Ω–µ—Ç–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç'
        ];
        
        const probabilities = [
            0.25, 0.2, 0.15, 0.1,
            0.08, 0.06, 0.05, 0.04,
            0.03, 0.02, 0.01, 0.005,
            0.002, 0.001, 0.0005, 0.0002
        ];
        
        const totalProb = probabilities.reduce((sum, p) => sum + p, 0);
        const normalizedProbs = probabilities.map(p => p / totalProb);
        
        const items = multipliers.map((m, i) => {
            const value = Math.round(basePrice * m);
            return {
                name: names[i],
                value: value,
                displayValue: `${value.toLocaleString()} $`,
                probability: normalizedProbs[i],
                rarity: rarities[i],
                icon: icons[i],
                multiplier: m
            };
        });
        
        return items;
    }

    const CASES_DATA = [
        { id: 'starter_case', name: '–°—Ç–∞—Ä—Ç–æ–≤—ã–π –ö–µ–π—Å', price: 100, icon: 'üéÅ', items: CASE_CONFIGS.starter_case },
        { id: 'rare_case', name: '–†–µ–¥–∫–∏–π –ö–µ–π—Å', price: 300, icon: 'üíé', items: CASE_CONFIGS.rare_case },
        { id: 'epic_case', name: '–≠–ø–∏—á–µ—Å–∫–∏–π –ö–µ–π—Å', price: 500, icon: '‚ú®', items: CASE_CONFIGS.epic_case },
        { id: 'legendary_case', name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ö–µ–π—Å', price: 1000, icon: 'üëë', items: CASE_CONFIGS.legendary_case },
    ];

    // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Coin ---
    let coinSessions = [
        {
            id: 'test-session-1',
            creatorId: 'test-user-1',
            creatorName: 'Test Player',
            bet: 100,
            opponentId: null,
            creatorSide: '–û—Ä—ë–ª',
            opponentSide: '–†–µ—à–∫–∞',
            status: 'waiting',
            countdown: 15
        }
    ];

    // --- DOM —ç–ª–µ–º–µ–Ω—Ç—ã ---
    const casesPage = document.getElementById('cases-page');
    const caseDetailPage = document.getElementById('case-detail-page');
    const dicePage = document.getElementById('dice-page');
    const coinPage = document.getElementById('coin-page');
    
    const caseListContainer = document.getElementById('case-list-container');
    const backButton = document.getElementById('back-to-main');
    const userBalanceElement = document.getElementById('user-balance');
    
    const caseNameDisplay = document.getElementById('case-name-display');
    const caseIconDisplay = document.getElementById('case-icon-display');
    const casePriceDisplay = document.getElementById('case-price-display');
    const caseContentsDisplay = document.getElementById('case-contents-display');
    const buyCaseButton = document.getElementById('buy-case-button');

    const reelSection = document.getElementById('reel-section');
    const reelElement = document.getElementById('reel');
    const resultDisplay = document.getElementById('result-display');
    const wonItemIcon = document.getElementById('won-item-icon');
    const wonItemValue = document.getElementById('won-item-value');
    const wonItemRarity = document.getElementById('won-item-rarity');
    const tryAgainButton = document.getElementById('try-again-button');
    const messageBox = document.getElementById('message-box');
    
    const userNameElement = document.getElementById('user-name');
    const userPhotoElement = document.getElementById('user-photo');

    // –≠–ª–µ–º–µ–Ω—Ç—ã Dice
    const dicePercentDisplay = document.getElementById('dice-percent');
    const diceSlider = document.getElementById('dice-slider');
    const dicePercentInput = document.getElementById('dice-percent-input');
    const diceMinus5Btn = document.getElementById('dice-minus5');
    const diceMinus1Btn = document.getElementById('dice-minus1');
    const dicePlus1Btn = document.getElementById('dice-plus1');
    const dicePlus5Btn = document.getElementById('dice-plus5');
    
    const diceBetInput = document.getElementById('dice-bet-input');
    const diceBetMinBtn = document.getElementById('dice-bet-min');
    const diceBetHalfBtn = document.getElementById('dice-bet-half');
    const diceBetDoubleBtn = document.getElementById('dice-bet-double');
    const diceBetMaxBtn = document.getElementById('dice-bet-max');
    const diceBetMinus10Btn = document.getElementById('dice-bet-minus10');
    const diceBetMinus5Btn = document.getElementById('dice-bet-minus5');
    const diceBetPlus5Btn = document.getElementById('dice-bet-plus5');
    const diceBetPlus10Btn = document.getElementById('dice-bet-plus10');
    
    const diceWinAmount = document.getElementById('dice-win-amount');
    const dicePlayButton = document.getElementById('dice-play-button');
    const diceResult = document.getElementById('dice-result');
    const diceResultText = document.getElementById('dice-result-text');
    const diceResultAmount = document.getElementById('dice-result-amount');
    const diceTryAgainBtn = document.getElementById('dice-try-again');

    // –≠–ª–µ–º–µ–Ω—Ç—ã Coin
    const coinSessionsSection = document.getElementById('coin-sessions');
    const createCoinSessionBtn = document.getElementById('create-coin-session');
    const coinBetSection = document.getElementById('coin-bet-section');
    const coinBetInput = document.getElementById('coin-bet-input');
    const confirmCoinSessionBtn = document.getElementById('confirm-coin-session');
    const cancelCoinSessionBtn = document.getElementById('cancel-coin-session');
    const coinSessionList = document.getElementById('coin-session-list');
    const coinGame = document.getElementById('coin-game');
    const coinStatus = document.getElementById('coin-status');
    const coinCountdown = document.getElementById('coin-countdown');
    const coinSides = document.getElementById('coin-sides');
    const playerSide = document.getElementById('player-side');
    const opponentSide = document.getElementById('opponent-side');
    const coinSwapSideBtn = document.getElementById('coin-swap-side');
    const coinVideo = document.getElementById('coin-video');
    const coinResult = document.getElementById('coin-result');
    const coinResultIcon = document.getElementById('coin-result-icon');
    const coinResultText = document.getElementById('coin-result-text');
    const coinResultAmount = document.getElementById('coin-result-amount');
    const coinPlayAgainBtn = document.getElementById('coin-play-again');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –≤–∫–ª–∞–¥–æ–∫
    const tabCasesBtn = document.getElementById('tab-cases');
    const tabDiceBtn = document.getElementById('tab-dice');
    const tabCoinBtn = document.getElementById('tab-coin');

    // --- –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
    function showMainPage() {
        casesPage.classList.remove('hidden');
        caseDetailPage.classList.add('hidden');
        hideReelAndResult();
        updateBalanceDisplay();
    }

    function showCaseDetailPage(caseData) {
        currentCase = caseData;
        casesPage.classList.add('hidden');
        caseDetailPage.classList.remove('hidden');

        caseNameDisplay.textContent = caseData.name;
        caseIconDisplay.textContent = caseData.icon;
        casePriceDisplay.textContent = `–¶–µ–Ω–∞: ${caseData.price.toLocaleString()} $`;
        
        renderCaseContents(caseData.items);
        hideReelAndResult();
        buyCaseButton.disabled = false;
        buyCaseButton.textContent = '–ö—É–ø–∏—Ç—å –∫–µ–π—Å';
    }

    function renderCaseList() {
        caseListContainer.innerHTML = ''; 
        CASES_DATA.forEach(caseData => {
            const caseDiv = document.createElement('div');
            caseDiv.className = 'case-item p-4 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center';
            caseDiv.innerHTML = `
                <div class="text-5xl mb-3">${caseData.icon}</div>
                <h3 class="text-xl font-semibold mb-1">${caseData.name}</h3>
                <p class="text-lg text-blue-400">${caseData.price.toLocaleString()} $</p>
            `;
            caseDiv.addEventListener('click', () => showCaseDetailPage(caseData));
            caseListContainer.appendChild(caseDiv);
        });
    }

    function renderCaseContents(items) {
        caseContentsDisplay.innerHTML = '';
        const sortedItems = [...items].sort((a, b) => b.value - a.value);
        sortedItems.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = `case-content-item flex justify-between items-center rarity-${item.rarity}`;
            itemDiv.innerHTML = `
                <span class="flex items-center">
                    <span class="text-2xl mr-2">${item.icon}</span>
                    <span>${item.name} (${item.displayValue})</span>
                </span>
                <span class="text-sm text-gray-400">${(item.probability * 100).toFixed(3)}%</span>
            `;
            caseContentsDisplay.appendChild(itemDiv);
        });
    }

    function showMessage(text, duration = 3000) {
        messageBox.textContent = text;
        messageBox.style.display = 'block';
        setTimeout(() => { messageBox.style.display = 'none'; }, duration);
    }

    function updateBalanceDisplay() {
        userBalanceElement.textContent = `${userBalance.toLocaleString()} $`;
    }

    // --- –õ–æ–≥–∏–∫–∞ –ø–æ–∫—É–ø–∫–∏ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞ ---
    function selectWinningItem(items) {
        const rand = Math.random();
        let cumulativeProbability = 0;
        for (const item of items) {
            cumulativeProbability += item.probability;
            if (rand <= cumulativeProbability) { return item; }
        }
        return items[items.length - 1]; 
    }
    
    function startReelAnimation(items, winningItem) {
        reelSection.classList.remove('hidden');
        resultDisplay.classList.add('hidden');
        reelElement.innerHTML = ''; 
        reelElement.style.transform = 'translateX(0px)'; 

        const reelItemsCount = 50; 
        const visualItems = [];
        for (let i = 0; i < reelItemsCount; i++) {
             visualItems.push(items[Math.floor(Math.random() * items.length)]);
        }
        
        const targetVisibleIndex = Math.floor(reelItemsCount * 0.85); 
        visualItems[targetVisibleIndex] = winningItem;

        visualItems.forEach(item => {
            const reelItemDiv = document.createElement('div');
            reelItemDiv.className = 'reel-item';
            reelItemDiv.innerHTML = `
                <div class="reel-item-icon ${item.rarity}">${item.icon}</div>
                <div class="reel-item-value">${item.name}</div>
                <div class="text-xs text-gray-400">${item.displayValue}</div>
            `;
            reelElement.appendChild(reelItemDiv);
        });
        
        const itemWidth = 100 + 10; 
        const containerWidth = reelElement.parentElement.offsetWidth;
        let offset = (targetVisibleIndex * itemWidth) - (containerWidth / 2) + (itemWidth / 2);

        reelElement.offsetHeight; 

        reelElement.style.transition = 'transform 5s cubic-bezier(0.1, 0.7, 0.3, 1)';
        reelElement.style.transform = `translateX(-${offset}px)`;

        setTimeout(() => {
            showWinningResult(winningItem);
            buyCaseButton.disabled = false; 
            buyCaseButton.textContent = '–ö—É–ø–∏—Ç—å –∫–µ–π—Å';
        }, 5100); 
    }

    function showWinningResult(item) {
        reelSection.classList.add('hidden');
        resultDisplay.classList.remove('hidden');
        wonItemIcon.textContent = item.icon;
        wonItemValue.textContent = `${item.name} (${item.displayValue})`;
        wonItemRarity.textContent = `–†–µ–¥–∫–æ—Å—Ç—å: ${item.rarity}`;
        wonItemRarity.className = `text-lg rarity-${item.rarity}`;
        
        userBalance += item.value;
        updateBalanceDisplay();
        
        if (item.value < currentCase.price) {
            const loss = currentCase.price - item.value;
            totalLosses += loss;
            jackpotPool += loss * 0.9;
        }
        
        if (jackpotPool > currentCase.price * 100) {
            distributeJackpot();
        }
    }
    
    function distributeJackpot() {
        if (jackpotPool <= 0) return;
        
        const reward = Math.floor(jackpotPool * 0.1);
        userBalance += reward;
        jackpotPool -= reward;
        
        showMessage(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${reward.toLocaleString()} $ –∏–∑ –æ–±—â–µ–≥–æ –ø—É–ª–∞!`, 5000);
        updateBalanceDisplay();
    }
    
    function hideReelAndResult() {
        reelSection.classList.add('hidden');
        resultDisplay.classList.add('hidden');
    }

    // --- –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã Dice ---
    function updateDiceWinAmount() {
        const percent = parseInt(dicePercentInput.value);
        const bet = parseInt(diceBetInput.value);
        
        const winAmount = bet * (99 / percent) * 0.95;
        diceWinAmount.textContent = `–í—ã–∏–≥—Ä—ã—à: ${winAmount.toFixed(2)} $`;
    }

    function playDiceGame() {
        const percent = parseInt(dicePercentInput.value);
        const bet = parseInt(diceBetInput.value);
        
        if (bet < 2 || bet > 1000) {
            showMessage('–°—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 2 –¥–æ 1000!');
            return;
        }
        
        if (userBalance < bet) {
            showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!');
            return;
        }
        
        userBalance -= bet;
        updateBalanceDisplay();
        
        const randomNumber = Math.random() * 100;
        const isWin = randomNumber < percent;
        
        setTimeout(() => {
            if (isWin) {
                const winAmount = Math.floor(bet * (99 / percent) * 0.95);
                userBalance += winAmount;
                updateBalanceDisplay();
                
                diceResultText.textContent = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!';
                diceResultAmount.textContent = `+${winAmount.toLocaleString()} $`;
                diceResultAmount.className = 'text-lg text-green-400';
                
                const casinoLoss = winAmount - bet;
                if (casinoLoss > 0) {
                    totalLosses += casinoLoss;
                    jackpotPool += casinoLoss * 0.9;
                }
            } else {
                diceResultText.textContent = '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏';
                diceResultAmount.textContent = `-${bet.toLocaleString()} $`;
                diceResultAmount.className = 'text-lg text-red-400';
                
                totalLosses += bet;
                jackpotPool += bet * 0.9;
            }
            
            diceResult.classList.remove('hidden');
        }, 1000);
    }

    // --- –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã Coin ---
    function renderCoinSessions() {
        coinSessionList.innerHTML = '';
        coinSessions.forEach(session => {
            const isOwnSession = session.creatorId === userId;
            const sessionDiv = document.createElement('div');
            sessionDiv.className = `coin-session ${!isOwnSession && !session.opponentId ? 'cursor-pointer' : ''}`;
            sessionDiv.innerHTML = `
                <div class="flex justify-between">
                    <span>–°—Ç–∞–≤–∫–∞: ${session.bet.toLocaleString()} $</span>
                    <span>–ò–≥—Ä–æ–∫: ${session.creatorName}</span>
                </div>
                <div class="text-sm text-gray-400">
                    ${isOwnSession ? '–í–∞—à–∞ —Å–µ—Å—Å–∏—è (–æ–∂–∏–¥–∞–Ω–∏–µ)' : session.opponentId ? '–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å' : '–û–∂–∏–¥–∞–µ—Ç –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞'}
                </div>
            `;
            if (!isOwnSession && !session.opponentId) {
                sessionDiv.addEventListener('click', () => joinCoinSession(session.id));
            }
            coinSessionList.appendChild(sessionDiv);
        });
    }

    function createCoinSession() {
        const bet = parseInt(coinBetInput.value);
        if (isNaN(bet) || bet < 10 || bet > 10000) {
            showMessage('–°—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 10 –¥–æ 10000!');
            return;
        }
        if (userBalance < bet) {
            showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!');
            return;
            socket.emit('createRoom', {
            bet,
            playerId: userId,
            playerName: userNameElement.textContent
        });
        }

        userBalance -= bet;
        updateBalanceDisplay();

        const session = {
            id: Math.random().toString(36).substr(2, 9),
            creatorId: userId,
            creatorName: userNameElement.textContent,
            bet,
            opponentId: null,
            creatorSide: Math.random() < 0.5 ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞',
            status: 'waiting',
            countdown: 15
        };
        session.opponentSide = session.creatorSide === '–û—Ä—ë–ª' ? '–†–µ—à–∫–∞' : '–û—Ä—ë–ª';

        coinSessions.push(session);
        activeCoinSession = session;
        coinBetSection.classList.add('hidden');
        renderCoinSessions();
        startCoinGame();
    }

    function joinCoinSession(sessionId) {
        const session = coinSessions.find(s => s.id === sessionId);
        if (!session || session.opponentId) return;

        const bet = session.bet;
        if (userBalance < bet) {
            showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!');
            return;
            socket.emit('joinRoom', {
            roomId: sessionId,
            playerId: userId,
            playerName: userNameElement.textContent
        });
        }

        userBalance -= bet;
        updateBalanceDisplay();

        session.opponentId = userId;
        session.status = 'active';
        activeCoinSession = session;
        renderCoinSessions();
        startCoinGame();
    }

        function startCoinGame() {
        coinGame.classList.remove('hidden');
        coinSessionsSection.classList.add('hidden');
        createCoinSessionBtn.classList.add('hidden');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –æ—Ç—Å—á–µ—Ç–∞
        const countdownAnim = document.getElementById('countdown-animation');
        countdownAnim.style.display = 'block';
        countdownAnim.seek(0);
        countdownAnim.play();

        playerSide.textContent = activeCoinSession.creatorId === userId ? 
            `–í—ã: ${activeCoinSession.creatorSide}` : 
            `–í—ã: ${activeCoinSession.opponentSide}`;
        opponentSide.textContent = activeCoinSession.creatorId === userId ? 
            `–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫: ${activeCoinSession.opponentSide}` : 
            `–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫: ${activeCoinSession.creatorSide}`;

        coinStatus.textContent = '–ò–≥—Ä–∞ –Ω–∞—á–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑:';
        let countdown = activeCoinSession.countdown;
        coinCountdown.textContent = `${countdown} —Å–µ–∫`;

        const countdownInterval = setInterval(() => {
            countdown--;
            coinCountdown.textContent = `${countdown} —Å–µ–∫`;
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                // –°–∫—Ä—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –æ—Ç—Å—á–µ—Ç–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –±—Ä–æ—Å–∫–∞
                countdownAnim.style.display = 'none';
                playCoinGame();
            }
        }, 1000);

        coinSwapSideBtn.disabled = false;
        coinSwapSideBtn.textContent = '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–º–µ–Ω—è—Ç—å—Å—è —Å—Ç–æ—Ä–æ–Ω–∞–º–∏';
    }

    function swapCoinSides() {
        if (!activeCoinSession) return;

        showMessage('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫—É!', 2000);
        setTimeout(() => {
            const temp = activeCoinSession.creatorSide;
            activeCoinSession.creatorSide = activeCoinSession.opponentSide;
            activeCoinSession.opponentSide = temp;

            playerSide.textContent = activeCoinSession.creatorId === userId ? 
                `–í—ã: ${activeCoinSession.creatorSide}` : 
                `–í—ã: ${activeCoinSession.opponentSide}`;
            opponentSide.textContent = activeCoinSession.creatorId === userId ? 
                `–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫: ${activeCoinSession.opponentSide}` : 
                `–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫: ${activeCoinSession.creatorSide}`;
            
            showMessage('–°—Ç–æ—Ä–æ–Ω—ã –ø–æ–º–µ–Ω—è–ª–∏—Å—å!', 2000);
        }, 1000);
    }

        function playCoinGame() {
        coinSwapSideBtn.disabled = true;
        coinStatus.textContent = '–ë—Ä–æ—Å–æ–∫ –º–æ–Ω–µ—Ç—ã...';
        coinCountdown.classList.add('hidden');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –±—Ä–æ—Å–∫–∞ –º–æ–Ω–µ—Ç—ã
        const coinFlipAnim = document.getElementById('coin-flip-animation');
        coinFlipAnim.style.display = 'block';
        coinFlipAnim.seek(0);
        coinFlipAnim.play();

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const result = Math.random() < 0.5 ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞';
        const isCreator = activeCoinSession.creatorId === userId;
        const playerSide = isCreator ? activeCoinSession.creatorSide : activeCoinSession.opponentSide;
        const win = playerSide === result;

        const totalPot = activeCoinSession.bet * 2;
        const commission = totalPot * 0.03;
        const winAmount = Math.floor(totalPot - commission);

        setTimeout(() => {
            coinFlipAnim.style.display = 'none';
            coinStatus.textContent = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            coinResultIcon.textContent = result === '–û—Ä—ë–ª' ? 'ü¶Ö' : 'üõ°Ô∏è';
            coinResultText.textContent = win ? '–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!' : '–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!';
            coinResultAmount.textContent = win ? `+${winAmount.toLocaleString()} $` : `-${activeCoinSession.bet.toLocaleString()} $`;
            coinResult.classList.remove('hidden');

            if (win) {
                userBalance += winAmount;
                showMessage(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${winAmount.toLocaleString()} $!`, 5000);
            } else {
                showMessage('–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!', 5000);
                totalLosses += activeCoinSession.bet;
                jackpotPool += activeCoinSession.bet * 0.9;
            }

            updateBalanceDisplay();
            coinPlayAgainBtn.classList.remove('hidden');
            coinSessions = coinSessions.filter(s => s.id !== activeCoinSession.id);
            activeCoinSession = null;
            renderCoinSessions();
        }, 2000);
    }

    // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ---
    function switchTab(tab) {
        currentTab = tab;
        
        casesPage.classList.add('hidden');
        caseDetailPage.classList.add('hidden');
        dicePage.classList.add('hidden');
        coinPage.classList.add('hidden');
        diceResult.classList.add('hidden');
        
        tabCasesBtn.classList.remove('active');
        tabDiceBtn.classList.remove('active');
        tabCoinBtn.classList.remove('active');
        
        switch(tab) {
            case 'cases':
                tabCasesBtn.classList.add('active');
                showMainPage();
                break;
            case 'dice':
                tabDiceBtn.classList.add('active');
                dicePage.classList.remove('hidden');
                updateDiceWinAmount();
                break;
            case 'coin':
                tabCoinBtn.classList.add('active');
                coinPage.classList.remove('hidden');
                coinGame.classList.add('hidden');
                coinSessionsSection.classList.remove('hidden');
                createCoinSessionBtn.classList.remove('hidden');
                coinBetSection.classList.add('hidden');
                renderCoinSessions();
                break;
        }
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    function init() {
        renderCaseList();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–∑—É–Ω–∫–∞ Dice –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ 50%
        diceSlider.addEventListener('input', () => {
            const value = parseInt(diceSlider.value);
            dicePercentInput.value = value;
            dicePercentDisplay.textContent = `${value}%`;
            updateDiceWinAmount();
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é thumb –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
            const min = parseInt(diceSlider.min);
            const max = parseInt(diceSlider.max);
            const percent = (value - min) / (max - min) * 100;
            diceSlider.style.setProperty('--thumb-pos', `${percent}%`);
        });
        
        dicePercentInput.addEventListener('input', () => {
            let value = parseInt(dicePercentInput.value);
            if (isNaN(value)) value = 50;
            if (value < 1) value = 1;
            if (value > 80) value = 80;
            
            dicePercentInput.value = value;
            diceSlider.value = value;
            dicePercentDisplay.textContent = `${value}%`;
            updateDiceWinAmount();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é thumb
            const min = parseInt(diceSlider.min);
            const max = parseInt(diceSlider.max);
            const percent = (value - min) / (max - min) * 100;
            diceSlider.style.setProperty('--thumb-pos', `${percent}%`);
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏ thumb
        diceSlider.style.setProperty('--thumb-pos', '50%');
        
        diceMinus5Btn.addEventListener('click', () => {
            let value = parseInt(dicePercentInput.value) - 5;
            if (value < 1) value = 1;
            dicePercentInput.value = value;
            diceSlider.value = value;
            dicePercentDisplay.textContent = `${value}%`;
            updateDiceWinAmount();
            
            const min = parseInt(diceSlider.min);
            const max = parseInt(diceSlider.max);
            const percent = (value - min) / (max - min) * 100;
            diceSlider.style.setProperty('--thumb-pos', `${percent}%`);
        });
        
        diceMinus1Btn.addEventListener('click', () => {
            let value = parseInt(dicePercentInput.value) - 1;
            if (value < 1) value = 1;
            dicePercentInput.value = value;
            diceSlider.value = value;
            dicePercentDisplay.textContent = `${value}%`;
            updateDiceWinAmount();
            
            const min = parseInt(diceSlider.min);
            const max = parseInt(diceSlider.max);
            const percent = (value - min) / (max - min) * 100;
            diceSlider.style.setProperty('--thumb-pos', `${percent}%`);
        });
        
        dicePlus1Btn.addEventListener('click', () => {
            let value = parseInt(dicePercentInput.value) + 1;
            if (value > 80) value = 80;
            dicePercentInput.value = value;
            diceSlider.value = value;
            dicePercentDisplay.textContent = `${value}%`;
            updateDiceWinAmount();
            
            const min = parseInt(diceSlider.min);
            const max = parseInt(diceSlider.max);
            const percent = (value - min) / (max - min) * 100;
            diceSlider.style.setProperty('--thumb-pos', `${percent}%`);
        });
        
        dicePlus5Btn.addEventListener('click', () => {
            let value = parseInt(dicePercentInput.value) + 5;
            if (value > 80) value = 80;
            dicePercentInput.value = value;
            diceSlider.value = value;
            dicePercentDisplay.textContent = `${value}%`;
            updateDiceWinAmount();
            
            const min = parseInt(diceSlider.min);
            const max = parseInt(diceSlider.max);
            const percent = (value - min) / (max - min) * 100;
            diceSlider.style.setProperty('--thumb-pos', `${percent}%`);
        });
        
        diceBetInput.addEventListener('input', () => {
            let value = parseInt(diceBetInput.value);
            if (isNaN(value)) value = 10;
            if (value < 2) value = 2;
            if (value > 1000) value = 1000;
            diceBetInput.value = value;
            updateDiceWinAmount();
        });
        
        diceBetMinBtn.addEventListener('click', () => {
            diceBetInput.value = 2;
            updateDiceWinAmount();
        });
        
        diceBetHalfBtn.addEventListener('click', () => {
            let value = Math.max(2, Math.floor(parseInt(diceBetInput.value) / 2));
            diceBetInput.value = value;
            updateDiceWinAmount();
        });
        
        diceBetDoubleBtn.addEventListener('click', () => {
            let value = Math.min(1000, parseInt(diceBetInput.value) * 2);
            diceBetInput.value = value;
            updateDiceWinAmount();
        });
        
        diceBetMaxBtn.addEventListener('click', () => {
            diceBetInput.value = 1000;
            updateDiceWinAmount();
        });
        
        diceBetMinus10Btn.addEventListener('click', () => {
            let value = Math.max(2, parseInt(diceBetInput.value) - 10);
            diceBetInput.value = value;
            updateDiceWinAmount();
        });
        
        diceBetMinus5Btn.addEventListener('click', () => {
            let value = Math.max(2, parseInt(diceBetInput.value) - 5);
            diceBetInput.value = value;
            updateDiceWinAmount();
        });
        
        diceBetPlus5Btn.addEventListener('click', () => {
            let value = Math.min(1000, parseInt(diceBetInput.value) + 5);
            diceBetInput.value = value;
            updateDiceWinAmount();
        });
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—Ä–æ—Å–∫–∞ –º–æ–Ω–µ—Ç—ã
        socket.on('flipCoin', ({ roomId }) => {
        const room = rooms[roomId];
        if (!room || room.status !== 'active') return;
        
        room.status = 'finished';
        const result = Math.random() < 0.5 ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞';
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        const creatorWon = room.creatorSide === result;
        const winner = creatorWon ? room.players[0] : room.players[1];
        const loser = creatorWon ? room.players[1] : room.players[0];
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        io.to(roomId).emit('coinResult', {
            result,
            winner: winner.id,
            winAmount: room.bet * 2 * 0.97 // 3% –∫–æ–º–∏—Å—Å–∏—è
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
        delete rooms[roomId];
        io.emit('roomsUpdated', Object.values(rooms));
        });
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        socket.on('coinResult', ({ result, winner, winAmount }) => {
        const isWinner = winner === userId;
        
        coinResultIcon.textContent = result === '–û—Ä—ë–ª' ? 'ü¶Ö' : 'üõ°Ô∏è';
        coinResultText.textContent = isWinner ? '–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!' : '–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!';
        coinResultAmount.textContent = isWinner ? 
            `+${winAmount.toLocaleString()} $` : 
            `-${activeCoinSession.bet.toLocaleString()} $`;
        
        if (isWinner) {
            userBalance += winAmount;
        }
        
        updateBalanceDisplay();
        coinResult.classList.remove('hidden');
        coinPlayAgainBtn.classList.remove('hidden');
        });
        diceBetPlus10Btn.addEventListener('click', () => {
            let value = Math.min(1000, parseInt(diceBetInput.value) + 10);
            diceBetInput.value = value;
            updateDiceWinAmount();
        });
        
        dicePlayButton.addEventListener('click', playDiceGame);
        diceTryAgainBtn.addEventListener('click', () => diceResult.classList.add('hidden'));
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Coin
        createCoinSessionBtn.addEventListener('click', () => {
            coinBetSection.classList.remove('hidden');
            createCoinSessionBtn.classList.add('hidden');
        });
        confirmCoinSessionBtn.addEventListener('click', createCoinSession);
        cancelCoinSessionBtn.addEventListener('click', () => {
            coinBetSection.classList.add('hidden');
            createCoinSessionBtn.classList.remove('hidden');
        });
        coinSwapSideBtn.addEventListener('click', () => {
        socket.emit('coinAction', {
            action: 'swap',
            roomId: activeCoinSession.id
        });
        });
        coinPlayAgainBtn.addEventListener('click', () => switchTab('coin'));
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
        tabCasesBtn.addEventListener('click', () => switchTab('cases'));
        tabDiceBtn.addEventListener('click', () => switchTab('dice'));
        tabCoinBtn.addEventListener('click', () => switchTab('coin'));
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–µ–π—Å–æ–≤
        buyCaseButton.addEventListener('click', () => {
            if (!currentCase) return;
            
            if (userBalance < currentCase.price) {
                showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!');
                return;
            }
            
            userBalance -= currentCase.price;
            updateBalanceDisplay();
            
            buyCaseButton.disabled = true;
            buyCaseButton.textContent = '–û—Ç–∫—Ä—ã–≤–∞–µ–º...';
            const winningItem = selectWinningItem(currentCase.items);
            startReelAnimation(currentCase.items, winningItem);
        });

        tryAgainButton.addEventListener('click', () => {
            if (currentCase) { showCaseDetailPage(currentCase); }
        });

        backButton.addEventListener('click', showMainPage);
        
        // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();

            const user = tg.initDataUnsafe?.user;
            if (user) {
                updateUserProfile(user);
            } else {
                console.warn("No user data. Using default profile.");
                userNameElement.textContent = "–ì–æ—Å—Ç—å";
                userPhotoElement.src = "https://placehold.co/40x40/1E88E5/FFFFFF?text=G";
            }
        }
        
        switchTab('cases');
        updateBalanceDisplay();
    }

    function updateUserProfile(user) {
        let displayName = user.username || `${user.first_name || ''} ${user.last_name || ''}`.trim() || "User";
        userNameElement.textContent = displayName;

        if (user.photo_url) {
            userPhotoElement.src = user.photo_url;
        } else {
            const initials = (user.first_name ? user.first_name[0] : '') + (user.last_name ? user.last_name[0] : '');
            userPhotoElement.src = `https://placehold.co/40x40/1E88E5/FFFFFF?text=${initials.toUpperCase() || 'U'}`;
        }
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>